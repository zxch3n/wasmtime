<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Profiling with VTune - Wasmtime</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="tutorial.html"><strong aria-hidden="true">2.</strong> Tutorial</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tutorial-create-hello-world.html"><strong aria-hidden="true">2.1.</strong> Creating hello-world.wasm</a></li><li class="chapter-item expanded "><a href="tutorial-run-hello-world.html"><strong aria-hidden="true">2.2.</strong> Running hello-world.wasm</a></li></ol></li><li class="chapter-item expanded "><a href="examples.html"><strong aria-hidden="true">3.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="examples-markdown.html"><strong aria-hidden="true">3.1.</strong> Markdown Parser</a></li><li class="chapter-item expanded "><a href="examples-debugging.html"><strong aria-hidden="true">3.2.</strong> Debugging WebAssembly</a></li><li class="chapter-item expanded "><a href="examples-profiling.html"><strong aria-hidden="true">3.3.</strong> Profiling WebAssembly</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="examples-profiling-perf.html"><strong aria-hidden="true">3.3.1.</strong> Profiling with Perf</a></li><li class="chapter-item expanded "><a href="examples-profiling-vtune.html" class="active"><strong aria-hidden="true">3.3.2.</strong> Profiling with VTune</a></li></ol></li><li class="chapter-item expanded "><a href="examples-rust-embed.html"><strong aria-hidden="true">3.4.</strong> Embedding in Rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="examples-rust-hello-world.html"><strong aria-hidden="true">3.4.1.</strong> Hello, world!</a></li><li class="chapter-item expanded "><a href="examples-rust-gcd.html"><strong aria-hidden="true">3.4.2.</strong> Calculating the GCD</a></li><li class="chapter-item expanded "><a href="examples-rust-memory.html"><strong aria-hidden="true">3.4.3.</strong> Using Linear Memory</a></li><li class="chapter-item expanded "><a href="examples-rust-wasi.html"><strong aria-hidden="true">3.4.4.</strong> WASI</a></li><li class="chapter-item expanded "><a href="examples-rust-linking.html"><strong aria-hidden="true">3.4.5.</strong> Linking Modules</a></li><li class="chapter-item expanded "><a href="examples-rust-debugging.html"><strong aria-hidden="true">3.4.6.</strong> Debugging</a></li><li class="chapter-item expanded "><a href="examples-rust-multi-value.html"><strong aria-hidden="true">3.4.7.</strong> Using Multi-Value</a></li></ol></li><li class="chapter-item expanded "><a href="examples-c-embed.html"><strong aria-hidden="true">3.5.</strong> Embedding in C</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="examples-c-hello-world.html"><strong aria-hidden="true">3.5.1.</strong> Hello, World!</a></li><li class="chapter-item expanded "><a href="examples-c-gcd.html"><strong aria-hidden="true">3.5.2.</strong> Calculating the GCD</a></li><li class="chapter-item expanded "><a href="examples-c-memory.html"><strong aria-hidden="true">3.5.3.</strong> Using Linear Memory</a></li><li class="chapter-item expanded "><a href="examples-c-wasi.html"><strong aria-hidden="true">3.5.4.</strong> WASI</a></li><li class="chapter-item expanded "><a href="examples-c-linking.html"><strong aria-hidden="true">3.5.5.</strong> Linking Modules</a></li><li class="chapter-item expanded "><a href="examples-c-debugging.html"><strong aria-hidden="true">3.5.6.</strong> Debugging</a></li><li class="chapter-item expanded "><a href="examples-c-multi-value.html"><strong aria-hidden="true">3.5.7.</strong> Using Multi-Value</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="lang.html"><strong aria-hidden="true">4.</strong> Using WebAssembly from your language</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lang-rust.html"><strong aria-hidden="true">4.1.</strong> Rust</a></li><li class="chapter-item expanded "><a href="lang-c.html"><strong aria-hidden="true">4.2.</strong> C</a></li><li class="chapter-item expanded "><a href="lang-python.html"><strong aria-hidden="true">4.3.</strong> Python</a></li><li class="chapter-item expanded "><a href="lang-dotnet.html"><strong aria-hidden="true">4.4.</strong> .NET</a></li><li class="chapter-item expanded "><a href="lang-go.html"><strong aria-hidden="true">4.5.</strong> Go</a></li><li class="chapter-item expanded "><a href="lang-bash.html"><strong aria-hidden="true">4.6.</strong> Bash</a></li></ol></li><li class="chapter-item expanded "><a href="cli.html"><strong aria-hidden="true">5.</strong> Using the wasmtime CLI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cli-install.html"><strong aria-hidden="true">5.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="cli-options.html"><strong aria-hidden="true">5.2.</strong> CLI Options</a></li><li class="chapter-item expanded "><a href="cli-cache.html"><strong aria-hidden="true">5.3.</strong> Cache Configuration</a></li></ol></li><li class="chapter-item expanded "><a href="wasm.html"><strong aria-hidden="true">6.</strong> Writing WebAssembly</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="wasm-rust.html"><strong aria-hidden="true">6.1.</strong> Rust</a></li><li class="chapter-item expanded "><a href="wasm-c.html"><strong aria-hidden="true">6.2.</strong> C/C++</a></li><li class="chapter-item expanded "><a href="wasm-assemblyscript.html"><strong aria-hidden="true">6.3.</strong> AssemblyScript</a></li><li class="chapter-item expanded "><a href="wasm-wat.html"><strong aria-hidden="true">6.4.</strong> WebAssembly Text Format (*.wat)</a></li></ol></li><li class="chapter-item expanded "><a href="stability.html"><strong aria-hidden="true">7.</strong> Stability</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="stability-release.html"><strong aria-hidden="true">7.1.</strong> Release Process</a></li><li class="chapter-item expanded "><a href="stability-tiers.html"><strong aria-hidden="true">7.2.</strong> Tiers of support</a></li><li class="chapter-item expanded "><a href="stability-platform-support.html"><strong aria-hidden="true">7.3.</strong> Platform Support</a></li><li class="chapter-item expanded "><a href="stability-wasm-proposals-support.html"><strong aria-hidden="true">7.4.</strong> Wasm Proposals Support</a></li></ol></li><li class="chapter-item expanded "><a href="security.html"><strong aria-hidden="true">8.</strong> Security</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="security-disclosure.html"><strong aria-hidden="true">8.1.</strong> Disclosure Policy</a></li></ol></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">9.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributing-architecture.html"><strong aria-hidden="true">9.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="contributing-building.html"><strong aria-hidden="true">9.2.</strong> Building</a></li><li class="chapter-item expanded "><a href="contributing-testing.html"><strong aria-hidden="true">9.3.</strong> Testing</a></li><li class="chapter-item expanded "><a href="contributing-fuzzing.html"><strong aria-hidden="true">9.4.</strong> Fuzzing</a></li><li class="chapter-item expanded "><a href="contributing-ci.html"><strong aria-hidden="true">9.5.</strong> CI</a></li><li class="chapter-item expanded "><a href="contributing-coding-guidelines.html"><strong aria-hidden="true">9.6.</strong> Coding Guidelines</a></li><li class="chapter-item expanded "><a href="contributing-development-process.html"><strong aria-hidden="true">9.7.</strong> Development Process</a></li><li class="chapter-item expanded "><a href="contributing-release-process.html"><strong aria-hidden="true">9.8.</strong> Release Process</a></li><li class="chapter-item expanded "><a href="contributing-implementing-wasm-proposals.html"><strong aria-hidden="true">9.9.</strong> Implementing Wasm Proposals</a></li><li class="chapter-item expanded "><a href="contributing-governance.html"><strong aria-hidden="true">9.10.</strong> Governance</a></li><li class="chapter-item expanded "><a href="contributing-coc.html"><strong aria-hidden="true">9.11.</strong> Code of Conduct</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Wasmtime</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="using-vtune"><a class="header" href="#using-vtune">Using <code>VTune</code></a></h1>
<p><a href="https://software.intel.com/en-us/vtune-help">VTune</a> is a popular performance profiling tool that targets both 32-bit
and 64-bit x86 architectures. The tool collects profiling data during runtime
and then, either through the command line or GUI, provides a variety of options
for viewing and analyzing that data. VTune Profiler is available in both
commerical and free options. The free, downloadable version is available
<a href="https://software.intel.com/en-us/vtune/choose-download#standalone">here</a> and is backed by a community forum for support. This version is
appropriate for detailed analysis of your Wasm program.</p>
<p>VTune support in Wasmtime is provided through the JIT profiling APIs from the
<a href="https://github.com/intel/ittapi"><code>ittapi</code></a> library. This library provides code generators (or the runtimes that
use them) a way to report JIT activities. The APIs are implemented in a static
library (see <a href="https://github.com/intel/ittapi"><code>ittapi</code></a> source) which Wasmtime links to when VTune support is
specified through the <code>vtune</code> Cargo feature flag; this feature is not enabled by
default. When the VTune collector is run, the <code>ittapi</code> library collects
Wasmtime's reported JIT activities. This connection to <code>ittapi</code> is provided by
the <a href="https://crates.io/crates/ittapi-rs"><code>ittapi-rs</code></a> crate.</p>
<p>For more information on VTune and the analysis tools it provides see its
<a href="https://software.intel.com/en-us/vtune-help">documentation</a>.</p>
<h3 id="turn-on-vtune-support"><a class="header" href="#turn-on-vtune-support">Turn on VTune support</a></h3>
<p>For JIT profiling with VTune, Wasmtime currently builds with the <code>vtune</code> feature
enabled by default. This ensures the compiled binary understands how to inform
the <code>ittapi</code> library of JIT events. But it must still be enabled at
runtime--enable runtime support based on how you use Wasmtime:</p>
<ul>
<li>
<p><strong>Rust API</strong> - call the [<code>Config::profiler</code>] method with
<code>ProfilingStrategy::VTune</code> to enable profiling of your wasm modules.</p>
</li>
<li>
<p><strong>C API</strong> - call the <code>wasmtime_config_profiler_set</code> API with a
<code>WASMTIME_PROFILING_STRATEGY_VTUNE</code> value.</p>
</li>
<li>
<p><strong>Command Line</strong> - pass the <code>--vtune</code> flag on the command line.</p>
</li>
</ul>
<h3 id="profiling-wasmtime-itself"><a class="header" href="#profiling-wasmtime-itself">Profiling Wasmtime itself</a></h3>
<p>Note that VTune is capable of profiling a single process or all system
processes. Like <code>perf</code>, VTune is capable of profiling the Wasmtime runtime
itself without any added support. However, the <a href="https://github.com/intel/ittapi"><code>ittapi</code></a> APIs also provide an
interface for marking the start and stop of code regions for easy isolation in
the VTune Profiler. Support for these APIs is expected to be added in the
future.</p>
<h3 id="example-getting-started"><a class="header" href="#example-getting-started">Example: Getting Started</a></h3>
<p>With VTune <a href="https://software.intel.com/en-us/vtune/choose-download#standalone">properly installed</a>, if you are using the CLI execute:</p>
<pre><code class="language-sh">$ cargo build
$ vtune -run-pass-thru=--no-altstack -collect hotspots target/debug/wasmtime --vtune foo.wasm
</code></pre>
<p>This command tells the VTune collector (<code>vtune</code>) to collect hot spot
profiling data as Wasmtime is executing <code>foo.wasm</code>. The <code>--vtune</code> flag enables
VTune support in Wasmtime so that the collector is also alerted to JIT events
that take place during runtime. The first time this is run, the result of the
command is a results diretory <code>r000hs/</code> which contains profiling data for
Wasmtime and the execution of <code>foo.wasm</code>. This data can then be read and
displayed via the command line or via the VTune GUI by importing the result.</p>
<h3 id="example-cli-collection"><a class="header" href="#example-cli-collection">Example: CLI Collection</a></h3>
<p>Using a familiar algorithm, we'll start with the following Rust code:</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let n = 45;
    println!(&quot;fib({}) = {}&quot;, n, fib(n));
}

fn fib(n: u32) -&gt; u32 {
    if n &lt;= 2 {
        1
    } else {
        fib(n - 1) + fib(n - 2)
    }
}
</code></pre></pre>
<p>We compile the example to Wasm:</p>
<pre><code class="language-sh">$ rustc --target wasm32-wasi fib.rs -C opt-level=z -C lto=yes
</code></pre>
<p>Then we execute the Wasmtime runtime (built with the <code>vtune</code> feature and
executed with the <code>--vtune</code> flag to enable reporting) inside the VTune CLI
application, <code>vtune</code>, which must already be installed and available on the
path. To collect hot spot profiling information, we execute:</p>
<pre><code class="language-sh">$ rustc --target wasm32-wasi fib.rs -C opt-level=z -C lto=yes
$ vtune -run-pass-thru=--no-altstack -v -collect hotspots target/debug/wasmtime --vtune fib.wasm
fib(45) = 1134903170
amplxe: Collection stopped.
amplxe: Using result path /home/jlb6740/wasmtime/r000hs
amplxe: Executing actions  7 % Clearing the database
amplxe: The database has been cleared, elapsed time is 0.239 seconds.
amplxe: Executing actions 14 % Updating precomputed scalar metrics
amplxe: Raw data has been loaded to the database, elapsed time is 0.792 seconds.
amplxe: Executing actions 19 % Processing profile metrics and debug information
...
Top Hotspots
Function                                                                                      Module          CPU Time
--------------------------------------------------------------------------------------------  --------------  --------
h2bacf53cb3845acf                                                                             [Dynamic code]    3.480s
__memmove_avx_unaligned_erms                                                                  libc.so.6         0.222s
cranelift_codegen::ir::instructions::InstructionData::opcode::hee6f5b6a72fc684e               wasmtime          0.122s
core::ptr::slice_from_raw_parts::hc5cb6f1b39a0e7a1                                            wasmtime          0.066s
_$LT$usize$u20$as$u20$core..slice..SliceIndex$LT$$u5b$T$u5d$$GT$$GT$::get::h70c7f142eeeee8bd  wasmtime          0.066s
</code></pre>
<h3 id="example-importing-results-into-gui"><a class="header" href="#example-importing-results-into-gui">Example: Importing Results into GUI</a></h3>
<p>Results directories created by the <code>vtune</code> CLI can be imported in the VTune GUI
by clicking &quot;Open &gt; Result&quot;. Below is a visualization of the collected data as
seen in VTune's GUI:</p>
<p><img src="assets/vtune-gui-fib.png" alt="vtune report output" /></p>
<h3 id="example-gui-collection"><a class="header" href="#example-gui-collection">Example: GUI Collection</a></h3>
<p>VTune can collect data in multiple ways (see <code>vtune</code> CLI discussion above);
another way is to use the VTune GUI directly. A standard work flow might look
like:</p>
<ul>
<li>Open VTune Profiler</li>
<li>&quot;Configure Analysis&quot; with
<ul>
<li>&quot;Application&quot; set to <code>/path/to/wasmtime</code> (e.g., <code>target/debug/wasmtime</code>)</li>
<li>&quot;Application parameters&quot; set to <code>--vtune /path/to/module.wasm</code></li>
<li>&quot;Working directory&quot; set as appropriate</li>
<li>Enable &quot;Hardware Event-Based Sampling,&quot; which may require some system
configuration, e.g. <code>sysctl -w kernel.perf_event_paranoid=0</code></li>
</ul>
</li>
<li>Start the analysis</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="examples-profiling-perf.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="examples-rust-embed.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="examples-profiling-perf.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="examples-rust-embed.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
